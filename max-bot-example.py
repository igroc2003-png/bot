"""
–ü—Ä–æ—Å—Ç–µ–π—à–∏–π –ø—Ä–∏–º–µ—Ä –±–æ—Ç–∞ –Ω–∞ MaxBot –±–µ–∑ Telegram –∏ –±–µ–∑ –≤–µ–±—Ö—É–∫–æ–≤.
–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π –≤–≤–æ–¥ –∏–∑ –∫–æ–Ω—Å–æ–ª–∏.
"""

import re
from maxbot import MaxBot

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º MaxBot —Å –ø—Ä–æ—Å—Ç—ã–º –¥–∏–∞–ª–æ–≥–æ–º
bot = MaxBot.inline(
    """
    dialog:
      - condition: message.text.lower() in ['hello', 'hi', '–ø—Ä–∏–≤–µ—Ç', '–∑–¥—Ä–∞–≤—Å—Ç–≤—É–π']
        response: |
          –ü—Ä–∏–≤–µ—Ç! –Ø –±–æ—Ç –Ω–∞ MaxBot.
          –ö–∞–∫ –¥–µ–ª–∞?

      - condition: message.text.lower() in ['good bye', 'bye', '–ø–æ–∫–∞', '–¥–æ —Å–≤–∏–¥–∞–Ω–∏—è']
        response: |
          –î–æ —Å–≤–∏–¥–∞–Ω–∏—è! –£–¥–∞—á–∏!

      - condition: message.text == '/start'
        response: |
          –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å! –Ø –±–æ—Ç –Ω–∞ MaxBot.
          –ù–∞–ø–∏—à–∏—Ç–µ "–ø—Ä–∏–≤–µ—Ç" –∏–ª–∏ "hello" –¥–ª—è –Ω–∞—á–∞–ª–∞.

      - condition: true
        response: |
          –ò–∑–≤–∏–Ω–∏—Ç–µ, —è –Ω–µ –ø–æ–Ω—è–ª. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –Ω–∞–ø–∏—Å–∞—Ç—å "–ø—Ä–∏–≤–µ—Ç" –∏–ª–∏ "/start".
    """
)


def extract_text_from_reply(reply) -> str:
    """–ò–∑–≤–ª–µ–∫–∞–µ—Ç —Ç–µ–∫—Å—Ç –∏–∑ –æ—Ç–≤–µ—Ç–∞ MaxBot"""
    try:
        # –ï—Å–ª–∏ —ç—Ç–æ –æ–±—ä–µ–∫—Ç —Å –∞—Ç—Ä–∏–±—É—Ç–æ–º value
        if hasattr(reply, 'value'):
            return str(reply.value)
        # –ï—Å–ª–∏ —ç—Ç–æ –æ–±—ä–µ–∫—Ç —Å –º–µ—Ç–æ–¥–æ–º render
        elif hasattr(reply, 'render'):
            return str(reply.render())
        # –ò–Ω–∞—á–µ –ø—Ä–æ—Å—Ç–æ –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ —Å—Ç—Ä–æ–∫—É
        else:
            reply_text = str(reply)
            # –£–±–∏—Ä–∞–µ–º –ª–∏—à–Ω–∏–µ —Å–∏–º–≤–æ–ª—ã –∏–∑ —Å—Ç—Ä–æ–∫–æ–≤–æ–≥–æ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è –æ–±—ä–µ–∫—Ç–∞
            if reply_text.startswith('<maxml.markup.Value'):
                # –ò–∑–≤–ª–µ–∫–∞–µ–º —Ç–µ–∫—Å—Ç –∏–∑ —Å—Ç—Ä–æ–∫–∏ –≤–∏–¥–∞ "<maxml.markup.Value'—Ç–µ–∫—Å—Ç'>"
                match = re.search(r"'([^']+)'", reply_text)
                if match:
                    return match.group(1)
            return reply_text
    except Exception:
        return str(reply)


def main() -> None:
    """–ó–∞–ø—É—Å–∫ –±–æ—Ç–∞ –¥–ª—è –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä–∞ Max (–±–µ–∑ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–≥–æ –≤–≤–æ–¥–∞)"""
    import time
    import sys
    
    print("üöÄ MaxBot –∑–∞–ø—É—â–µ–Ω –¥–ª—è –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä–∞ Max")
    print("‚úÖ –ë–æ—Ç –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ. –û–∂–∏–¥–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π...")
    print("‚ÑπÔ∏è  –ë–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ —Ñ–æ–Ω–æ–≤–æ–º —Ä–µ–∂–∏–º–µ")
    print("‚ÑπÔ∏è  –î–ª—è —Ä–∞–±–æ—Ç—ã —Å Max API –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ webhook –∏–ª–∏ long polling")
    
    # –î–µ—Ä–∂–∏–º –ø—Ä–æ—Ü–µ—Å—Å –∑–∞–ø—É—â–µ–Ω–Ω—ã–º
    # –í —Ä–µ–∞–ª—å–Ω–æ–º –±–æ—Ç–µ –∑–¥–µ—Å—å –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Max API
    # (webhook endpoint –∏–ª–∏ long polling)
    try:
        while True:
            time.sleep(60)  # –°–ø–∏–º 60 —Å–µ–∫—É–Ω–¥, —á—Ç–æ–±—ã –Ω–µ –Ω–∞–≥—Ä—É–∂–∞—Ç—å CPU
            # –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π —á–µ—Ä–µ–∑ Max API
    except KeyboardInterrupt:
        print("\nüëã –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –±–æ—Ç–∞...")
        sys.exit(0)
    except Exception as exc:
        print(f"‚ö†Ô∏è –û—à–∏–±–∫–∞: {exc}")
        sys.exit(1)


if __name__ == "__main__":
    main()
